# Руководство по тестированию генератора задач ЕГЭ по математике

## Предварительные требования

Перед запуском тестов убедитесь, что:

1. Установлены все необходимые зависимости из файла `requirements.txt`:
   ```bash
   pip install -r requirements.txt
   ```

2. Создан файл `.env` в корневом каталоге проекта, содержащий следующие переменные:
   ```
   YANDEX_API_KEY=ваш_ключ_API_Яндекса
   YANDEX_FOLDER_ID=идентификатор_вашей_папки
   ```

3. В системе установлены необходимые пакеты для работы с математическими выражениями и визуализацией:
   ```bash
   pip install sympy matplotlib numpy pillow
   ```

## Виды тестов

Система содержит несколько типов тестов:

1. **Функциональные тесты** - проверяют работу отдельных функций и модулей
2. **Интеграционные тесты** - проверяют взаимодействие между компонентами
3. **Тесты визуализации** - проверяют генерацию изображений
4. **Тесты качества** - проверяют соответствие сгенерированных задач ожидаемым результатам

## Запуск тестов

### Запуск всех тестов

Чтобы запустить все тесты, выполните:

```bash
python -m tests.run_all_tests
```

Для получения отчёта о покрытии тестами добавьте флаг `--cov`:

```bash
python -m tests.run_all_tests --cov=app --cov-report=html
```

### Запуск отдельных модулей тестирования

Вы можете запускать тесты для конкретных компонентов:

#### Тесты генерации задач:
```bash
python -m unittest tests.test_task_generator
```

#### Тесты визуализации:
```bash
python -m unittest tests.test_visualization
```

#### Тесты геометрических фигур:
```bash
python -m unittest tests.test_shapes
```

#### Тесты визуализации графиков:
```bash
python -m unittest tests.test_graph_visualization
```

### Тесты качества генерации задач

Для запуска тестов качества используйте:

```bash
python -m tests.quality_tests.run_quality_tests
```

Для получения подробного отчета о качестве генерируемых задач:
```bash
python -m tests.quality_tests.run_quality_tests --verbose --save-report
```

## Тестирование визуализации

### Тестирование геометрических фигур

Тесты визуализации включают проверку корректного отображения различных геометрических фигур:

- Треугольники (произвольные, равнобедренные, прямоугольные)
- Прямоугольники и квадраты
- Трапеции (произвольные и равнобедренные)
- Параллелограммы
- Окружности

#### Конкретные аспекты тестирования геометрических фигур:

- Автоматическое определение длин сторон на основе заданных размеров
- Корректное отображение углов в различных фигурах
- Проверка ограничения на количество вершин (не более 4)
- Правильное размещение меток вершин и длин сторон

#### Новые тесты для визуализации фигур:
- Проверка качества 3D-визуализации для стереометрических фигур
- Тестирование автоматического извлечения параметров из текста задач
- Проверка адаптивного масштабирования фигур
- Тестирование корректности отображения специальных точек (центры, ортоцентры и т.п.)

Запуск всех тестов визуализации геометрических фигур:
```bash
python -m unittest tests.test_all_figures_visual
```

### Тестирование графиков функций

Тесты визуализации графиков проверяют корректное отображение различных типов функций:

- Линейные функции
- Полиномиальные функции
- Тригонометрические функции (включая корректное отображение \tg и других специальных функций)
- Логарифмические и показательные функции
- Несколько графиков на одном полотне

#### Новые тесты для визуализации графиков:
- Тестирование интерактивных графиков с использованием Plotly
- Проверка корректности визуализации точек пересечения графиков
- Тестирование отображения экстремумов и критических точек
- Проверка корректности масштабирования для разных типов функций

Запуск тестов визуализации графиков:
```bash
python -m unittest tests.test_graph_visualization
```

Для сохранения результатов тестирования визуализации в виде изображений:
```bash
python -m unittest tests.test_graph_visualization --save-images
```

## Логирование

Результаты тестов записываются в лог-файлы:

- `test_results.log` - основной лог с результатами функциональных тестов
- `quality_tests.log` - лог с результатами тестов качества генерации задач
- `visualization_tests.log` - лог с результатами тестов визуализации

Для просмотра логов в реальном времени используйте:

```bash
tail -f test_results.log
```

## Тестирование генерации задач

### Новые тесты для улучшения генерации:

- **Тесты корректности условий задач**
  - Проверка математической корректности условий
  - Тестирование однозначности интерпретации условий

- **Тесты качества решений**
  - Проверка полноты предоставленных решений
  - Тестирование корректности промежуточных шагов
  - Проверка корректности конечных ответов

- **Тесты на разнообразие генерации**
  - Проверка отсутствия повторяющихся шаблонов при генерации
  - Тестирование разнообразия используемых подходов в решениях

- **Автоматизированная валидация**
  - Верификация решений с помощью математических библиотек
  - Тестирование соответствия подсказок и полного решения

### Запуск тестов генерации:

```bash
python -m tests.test_task_generator_quality --category="Алгебраические уравнения" --count=10
```

## Советы по тестированию

1. **Отладка тестов**: При возникновении ошибок, добавьте дополнительные логи, используя:
   ```python
   import logging
   logging.debug("Значение переменной: %s", variable)
   ```

2. **Изолированное тестирование**: Для отладки конкретного функционала используйте специальные тестовые скрипты в корне проекта, например:
   ```bash
   python test_specific_function.py
   ```

3. **Визуальная проверка**: Для оценки визуализаций, используйте ручную проверку, запустив:
   ```bash
   python test_all_figures_visual.py
   ```
   
   Результаты будут сохранены в директории `test_images/`.

## Примеры команд для тестирования конкретных сценариев

### Тестирование трапеции с различными параметрами:
```bash
python -c "from app.geometry.trapezoid import Trapezoid; from app.visualization.renderer import GeometryRenderer; params = {'bottom_width': 6, 'top_width': 3, 'height': 3, 'show_labels': True, 'is_isosceles': True, 'vertex_labels': ['A', 'B', 'C', 'D']}; trapezoid = Trapezoid(params); GeometryRenderer.render_figure(trapezoid, 'test_trapezoid.png')"
```

### Тестирование прямоугольника с конкретными размерами:
```bash
python -c "from app.geometry.rectangle import Rectangle; from app.visualization.renderer import GeometryRenderer; params = {'width': 5, 'height': 3, 'show_labels': True, 'vertex_labels': ['A', 'B', 'C', 'D']}; rect = Rectangle(params); GeometryRenderer.render_figure(rect, 'test_rectangle.png')"
```

### Генерация и визуализация задачи по теме "Анализ графиков и диаграмм":
```bash
python -c "from app.task_generator import generate_complete_task; result = generate_complete_task('Анализ графиков и диаграмм', difficulty_level=3); print(result)"
```

### Тестирование генерации нескольких графиков на одном полотне:
```bash
python -c "from app.visualization.chart_utils import process_multiple_function_plots; process_multiple_function_plots(['x**2', 'x', 'sin(x)'], ['red', 'blue', 'green'], ['f(x)=x²', 'g(x)=x', 'h(x)=sin(x)'], [(-5, 5), (-5, 5), (-5, 5)], [None, None, None], title='Тестовый график нескольких функций')"
```

### Тестирование извлечения параметров для визуализации:
```bash
python -c "from app.task_generator import extract_visualization_params; print(extract_visualization_params('Задача с графиком функции y = x² + 2x', 'Анализ графиков', ''))"
```

### Тестирование интерактивных графиков с Plotly:
```bash
python -c "from app.visualization.interactive_charts import create_interactive_plot; create_interactive_plot(['x**2', 'sin(x)'], ['Парабола', 'Синус'], 'test_interactive_plot.html')"
```

### Тестирование качества задач на конкретных типах задач:
```bash
python -m tests.quality_tests.run_specific_test --test-type="equation" --count=5 --difficulty=3
```

## Планы по расширению тестирования

В ближайшее время планируется добавление следующих тестов:

1. **Интеграционные тесты Flask API**
   - Тестирование всех маршрутов API
   - Проверка взаимодействия между фронтендом и бэкендом

2. **Тесты производительности**
   - Измерение времени генерации задач разных типов
   - Анализ потребления ресурсов при генерации визуализаций

3. **Е2E-тесты (End-to-End)**
   - Тестирование пользовательского интерфейса
   - Проверка полного цикла от генерации задачи до просмотра решения

4. **Стресс-тесты**
   - Тестирование системы при большом количестве одновременных запросов
   - Проверка стабильности при длительной работе

5. **A/B-тестирование промптов**
   - Сравнение качества задач, генерируемых с разными промптами
   - Анализ влияния параметров генерации на качество задач

## Анализ результатов тестирования

При анализе результатов обратите внимание на:

1. Процент успешных тестов
2. Типы возникающих ошибок
3. Соответствие сгенерированных задач ожидаемым форматам
4. Качество визуализации геометрических фигур и графиков
5. Полнота и корректность генерируемых решений
6. Соответствие подсказок полному решению и их педагогическая ценность

## Автоматизированные отчеты

После запуска полного набора тестов автоматически создаются следующие отчеты:

1. **HTML-отчет о покрытии кода** - показывает, какие части кода покрыты тестами
2. **Отчет о качестве задач** - содержит статистику по корректности генерируемых задач
3. **Визуальный отчет** - содержит примеры сгенерированных изображений
4. **Отчет о производительности** - показывает скорость работы различных компонентов

Все отчеты сохраняются в директории `test_reports/`. 